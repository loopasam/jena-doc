<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

  <link href="/jena-doc/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="/jena-doc/css/bootstrap-extension.css" rel="stylesheet" type="text/css">

  <title>Apache Jena - ARQ - Writing Filter Functions</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src="/js/jena-navigation.js" type="text/javascript"></script>
  <script src="/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
        <a class="brand" href="/jena-doc/index.html" style="padding-top: 6px; padding-bottom: 0px;">
            <img class="logo-menu" src="/images/jena-logo/jena-logo-notext-small.png">
          </a>
          <a class="brand" href="/jena-doc/index.html">Apache Jena</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li id="homepage"><a href="/jena-doc/index.html"><i class="icon-home"></i> Home</a></li>
              <li id="download"><a href="/jena-doc/download/index.html"><i class="icon-download-alt"></i> Download</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-book"></i> Learn <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li class="nav-header">Tutorials</li>
                  <li><a href="/jena-doc/tutorials/rdf_api.html">RDF core API tutorial</a></li>
                  <li><a href="/jena-doc/tutorials/sparql.html">SPARQL tutorial</a></li>
                  <li><a href="/jena-doc/documentation/query/manipulating_sparql_using_arq.html">Manipulating SPARQL using ARQ</a></li>
                  <li><a href="/jena-doc/tutorials/using_jena_with_eclipse.html">Using Jena with Eclipse</a></li>
                  <li><a href="/jena-doc/documentation/notes/index.html">Recipes</a></li>
                  <li class="divider"></li>
                  <li class="nav-header">Reference</li>
                  <li><a href="/jena-doc/documentation/index.html">Overview</a></li>
                  <li><a href="/jena-doc/documentation/javadoc/">Javadoc</a></li>
                  <li><a href="/jena-doc/documentation/tools/index.html">Command-line tools</a></li>
                  <li><a href="/jena-doc/documentation/rdf/index.html">RDF API</a></li>
                  <li><a href="/jena-doc/documentation/query/index.html">ARQ (SPARQL)</a></li>
                  <li><a href="/jena-doc/documentation/serving_data/index.html">Fuseki</a></li>
                  <li><a href="/jena-doc/documentation/tdb/index.html">TDB</a></li>
                  <li><a href="/jena-doc/documentation/assembler/index.html">Assembler</a></li>
                  <li><a href="/jena-doc/documentation/sdb/index.html">SDB</a></li>
                  <li><a href="/jena-doc/documentation/ontology/">Ontology API</a></li>
                  <li><a href="/jena-doc/documentation/inference/index.html">Inference API</a></li>
                </ul>
              </li>
              <li id="ask"><a href="/jena-doc/help_and_support/index.html"><i class="icon-question-sign"></i> Ask</a></li>
              
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-bullhorn"></i> Get involved <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="/jena-doc/getting_involved/index.html">Contribute</a></li>
                  <li><a href="/jena-doc/help_and_support/bugs_and_suggestions.html">Report a bug</a></li>
                  <li class="divider"></li>
                  <li class="nav-header">Project</li>
                  <li><a href="/jena-doc/about_jena/about.html">About Jena</a></li>
                  <li><a href="/jena-doc/about_jena/roadmap.html">Roadmap</a></li>
                  <li><a href="/jena-doc/about_jena/architecture.html">Architecture</a></li>
                  <li><a href="/jena-doc/about_jena/team.html">Project team</a></li>
                  <li><a href="/jena-doc/about_jena/contributions.html">Related projects</a></li>
                  <li class="divider"></li>
                  <li class="nav-header">ASF</li>
                  <li><a href="http://www.apache.org/">Apache Software Foundation</a></li>
                  <li><a href="http://www.apache.org/licenses/LICENSE-2.0">License</a></li>
                  <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
                  <li><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li>
                  <li><a href="http://www.apache.org/security/">Security</a></li>
                </ul>
              </li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>


<div class="container">
	<div class="row-fluid">
	<div class="span12">
	<h1 class="title">ARQ - Writing Filter Functions</h1>
  <p>Applications can add SPARQL functions to the query engine. This is
done by writing a class implementing the right interface, then
either registering it or using the fake <code>java:</code> URI scheme to
dynamically call the function.</p>
<h2 id="writing-sparql-value-functions">Writing SPARQL Value Functions</h2>
<p>A SPARQL value function is an extension point of the SPARQL query
language that allows URI to name a function in the query
processor.</p>
<p>In the ARQ engine, code to implement function must implement the
interface <code>com.hp.hpl.jena.sparql.function.Function</code> although it is
easier to work with one of the abstract classes for specific
numbers of arguments like
<code>com.hp.hpl.jena.sparql.function.FunctionBase1</code> for one argument
functions. Functions do not have to have a fixed number of
arguments.</p>
<p>The abstract class <code>FunctionBase</code>, the superclass of
<code>FunctionBase1</code> to <code>FunctionBase4</code>, evaluates its arguments and
calls the implementation code with argument values (if a variable
was unbound, an error will have been generated) </p>
<p>It is possible to get unevaluated arguments but care must be taken
not to violate the rules of function evaluation. The standard
functions that access unevaluated arguments are the logical 'or'
and logical 'and' operations that back <code>||</code> and <code>&amp;&amp;</code> are special
forms to allow for the special exception handling rules.</p>
<p>Normally, function should be a pure evaluation based on it's
argument. It should not access a graph nor return different values
for the same arguments (to allow expression optimization). Usually,
these requirements can be better met with a
<a href="library-propfunc.html">property function</a>. Functions can't bind a
variables; this would be done in a
<a href="library-propfunc.html">property function</a> as well.</p>
<p>Example: (this is the max function in the standard ARQ library):</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">max</span> <span class="n">extends</span> <span class="n">FunctionBase2</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">max</span><span class="p">()</span> <span class="p">{</span> <span class="n">super</span><span class="p">()</span> <span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="n">NodeValue</span> <span class="n">exec</span><span class="p">(</span><span class="n">NodeValue</span> <span class="n">nv1</span><span class="p">,</span> <span class="n">NodeValue</span> <span class="n">nv2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Functions</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">nv1</span><span class="p">,</span> <span class="n">nv2</span><span class="p">)</span> <span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The function takes two arguments and returns a single value. The
class NodeValue represents values and supports value-based
operations. NodeValue value support includes the XSD datatypes,
xsd:decimal and all it's subtypes like xsd:integer and xsd:byte,
xsd';double, xsd:float, xsd:boolean, xsd:dateTime and xsd:date.
Literals with language tags are also treated as values in
additional "value spaces" determined by the language tag without
regard to case.</p>
<p>The <code>Functions</code> class contains the core XML Functions and Operators
operations. Class NodeFunctions contains the implementations of
node-centric operations like <code>isLiteral</code> and <code>str</code>.</p>
<p>If any of the arguments are wrong, then the function should throw
<code>ExprEvalException</code>.</p>
<p>Example: calculate the canonical namespace from a URI (calls the
Jena operation for the actual work):</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">namespace</span> <span class="n">extends</span> <span class="n">FunctionBase1</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">namespace</span><span class="p">()</span> <span class="p">{</span> <span class="n">super</span><span class="p">()</span> <span class="p">;</span> <span class="p">}</span>

    <span class="n">public</span> <span class="n">NodeValue</span> <span class="n">exec</span><span class="p">(</span><span class="n">NodeValue</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Node</span> <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">asNode</span><span class="p">()</span> <span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="n">n</span><span class="p">.</span><span class="n">isURI</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">ExprEvalException</span><span class="p">(</span><span class="s">&quot;Not a URI: &quot;</span><span class="o">+</span><span class="n">FmtUtils</span><span class="p">.</span><span class="n">stringForNode</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">;</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">getNameSpace</span><span class="p">()</span> <span class="p">;</span>
        <span class="k">return</span> <span class="n">NodeValue</span><span class="p">.</span><span class="n">makeString</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This throws an evaluation exception if it is passed a value that is
not a URI.</p>
<p>The standard library, in package
<code>com.hp.hpl.jena.sparql.function.library</code>, contains many examples.</p>
<h2 id="registering-functions">Registering Functions</h2>
<p>The query compiler finds functions based on the functions URI. 
There is a global registry of known functions, but any query
execution can have it's own function registry.</p>
<p>For each function, there is a function factory associated with the
URI. A new function instance is created for each use of a function
in each query execution.</p>
<div class="codehilite"><pre><span class="c1">// Register with the global registry.</span>
<span class="n">FunctionRegistry</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;http://example.org/function#myFunction&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">MyFunctionFactory</span><span class="p">())</span> <span class="p">;</span>
</pre></div>


<p>A common case is registering a specific class for a function
implementation so there is an addition method that takes a class,
wraps in a built-in function factory and registers the function
implementation.</p>
<div class="codehilite"><pre><span class="c1">// Register with the global registry.</span>
<span class="n">FunctionRegistry</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;http://example.org/function#myFunction&quot;</span><span class="p">,</span> <span class="n">MyFunction</span><span class="p">.</span><span class="k">class</span><span class="p">)</span> <span class="p">;</span>
</pre></div>


<p>Another convenience route to function calling is to use the
<a href="java-uri.html"><code>java:</code> URI scheme</a>. This dynamically loads the code,
which must be on the Java classpath. With this scheme, the function
URI gives the class name. There is automatic registration of a
wrapper into the function registry. This way, no explicit
registration step is needed by the application and queries issues
with the command line tools can load custom functions.</p>
<div class="codehilite"><pre><span class="n">PREFIX</span> <span class="n">f</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">java</span><span class="o">:</span><span class="n">app</span><span class="p">.</span><span class="n">myFunctions</span><span class="p">.</span><span class="o">&gt;</span>
<span class="p">...</span>
   <span class="n">FILTER</span> <span class="n">f</span><span class="o">:</span><span class="n">myTest</span><span class="p">(</span><span class="o">?</span><span class="n">x</span><span class="p">,</span> <span class="o">?</span><span class="n">y</span><span class="p">)</span>
<span class="p">...</span>
   <span class="n">FILTER</span> <span class="p">(</span><span class="o">?</span><span class="n">x</span> <span class="o">+</span> <span class="n">f</span><span class="o">:</span><span class="n">myIntToXSD</span><span class="p">(</span><span class="o">?</span><span class="n">y</span><span class="p">))</span>
<span class="p">...</span>
</pre></div>


<p><a href="index.html">ARQ documentation index</a></p>
  </div>
</div>

	<hr>
    <div id="footer">
    <div class="copyright">
      <p>
        Copyright &copy; 2011&ndash;2013 The Apache Software Foundation, Licensed under
        the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        <br />
        Apache Jena, Jena, the Apache Jena project logo,
        Apache and the Apache feather logos are trademarks of The Apache Software Foundation.
      </p>
    </div>
  </div>
      
      
</div><!--/.container -->

</body>
</html>
